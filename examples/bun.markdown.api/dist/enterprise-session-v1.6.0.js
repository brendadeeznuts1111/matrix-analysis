// @bun
var Z={async fetch(G,x,E){let y=new URL(G.url),B={"Access-Control-Allow-Origin":x.PUBLIC_API_URL||"*","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, Cookie","Access-Control-Allow-Credentials":"true"};if(G.method==="OPTIONS")return new Response(null,{headers:B});try{switch(y.pathname){case"/api/health":return N(G,x,B);case"/api/login":return P(G,x,B);case"/api/logout":return Q(G,x,B);case"/api/user":return T(G,x,B);case"/api/sessions":return W(G,x,B);case"/api/metrics":return X(G,x,B);case"/debug/r2":return Y(G,x,B);default:return new Response(JSON.stringify({error:"Endpoint not found",version:x.PUBLIC_VERSION||"1.6.0",availableEndpoints:["/api/health","/api/login","/api/logout","/api/user","/api/sessions","/api/metrics"]}),{status:404,headers:{...B,"Content-Type":"application/json"}})}}catch(A){return console.error("Worker error:",A),new Response(JSON.stringify({error:"Internal server error",message:A?.message||"Unknown error",timestamp:new Date().toISOString()}),{status:500,headers:{...B,"Content-Type":"application/json"}})}}};async function N(G,x,E){let y={status:"healthy",version:x.PUBLIC_VERSION||"1.6.0",environment:x.CLOUDFLARE_ENV||"production",api_url:x.PUBLIC_API_URL,region:x.REGION||"global",data_center:x.DATA_CENTER||"auto",timestamp:new Date().toISOString(),uptime:Math.floor(Date.now()/1000),features:{r2_sessions:!!x.SESSIONS_BUCKET,kv_metadata:!!x.SESSION_METADATA,d1_database:!!x.USER_DB,queue_events:!!x.SESSION_EVENTS,analytics:!!x.ANALYTICS}};return new Response(JSON.stringify(y),{headers:{...E,"Content-Type":"application/json"}})}async function P(G,x,E){if(G.method!=="POST")return new Response(JSON.stringify({error:"Method not allowed"}),{status:405,headers:{...E,"Content-Type":"application/json"}});try{let{username:y,password:B}=await G.json();if(!y||!B)return new Response(JSON.stringify({error:"Missing credentials"}),{status:400,headers:{...E,"Content-Type":"application/json"}});let A=crypto.randomUUID(),F={sessionId:A,username:y,loginTime:new Date().toISOString(),expiresAt:new Date(Date.now()+86400000).toISOString(),userAgent:G.headers.get("User-Agent"),ip:G.headers.get("CF-Connecting-IP")||"unknown"};if(x.SESSIONS_BUCKET)await x.SESSIONS_BUCKET.put(`sessions/${A}`,JSON.stringify(F),{customMetadata:{username:y,loginTime:F.loginTime,expiresAt:F.expiresAt}});if(x.SESSION_METADATA)await x.SESSION_METADATA.put(`meta:${A}`,JSON.stringify({username:y,loginTime:F.loginTime,lastActivity:F.loginTime}),{expirationTtl:86400});if(x.SESSION_EVENTS)await x.SESSION_EVENTS.send({type:"login",sessionId:A,username:y,timestamp:F.loginTime,ip:F.ip,userAgent:F.userAgent});let J=`session=${A}; Path=/; HttpOnly; Secure; SameSite=Strict; Max-Age=86400`;return new Response(JSON.stringify({success:!0,sessionId:A,username:y,expiresAt:F.expiresAt}),{headers:{...E,"Content-Type":"application/json","Set-Cookie":J}})}catch(y){return new Response(JSON.stringify({error:"Login failed",message:y?.message||"Unknown error"}),{status:500,headers:{...E,"Content-Type":"application/json"}})}}async function Q(G,x,E){let B=G.headers.get("Cookie")?.match(/session=([^;]+)/)?.[1];if(B){if(x.SESSIONS_BUCKET)await x.SESSIONS_BUCKET.delete(`sessions/${B}`);if(x.SESSION_METADATA)await x.SESSION_METADATA.delete(`meta:${B}`);if(x.SESSION_EVENTS)await x.SESSION_EVENTS.send({type:"logout",sessionId:B,timestamp:new Date().toISOString()})}return new Response(JSON.stringify({success:!0}),{headers:{...E,"Content-Type":"application/json","Set-Cookie":"session=; Path=/; HttpOnly; Secure; SameSite=Strict; Max-Age=0"}})}async function T(G,x,E){let B=G.headers.get("Cookie")?.match(/session=([^;]+)/)?.[1];if(!B)return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{...E,"Content-Type":"application/json"}});try{let A=null;if(x.SESSIONS_BUCKET){let F=await x.SESSIONS_BUCKET.get(`sessions/${B}`);if(F)A=await F.json()}if(!A)return new Response(JSON.stringify({error:"Session not found"}),{status:401,headers:{...E,"Content-Type":"application/json"}});if(new Date(A.expiresAt)<new Date)return new Response(JSON.stringify({error:"Session expired"}),{status:401,headers:{...E,"Content-Type":"application/json"}});if(x.SESSION_METADATA)await x.SESSION_METADATA.put(`meta:${B}`,JSON.stringify({username:A.username,loginTime:A.loginTime,lastActivity:new Date().toISOString()}),{expirationTtl:86400});return new Response(JSON.stringify({sessionId:B,username:A.username,loginTime:A.loginTime,expiresAt:A.expiresAt,publicApiUrl:x.PUBLIC_API_URL}),{headers:{...E,"Content-Type":"application/json"}})}catch(A){return new Response(JSON.stringify({error:"Session validation failed",message:A?.message||"Unknown error"}),{status:500,headers:{...E,"Content-Type":"application/json"}})}}async function W(G,x,E){try{let y=[];if(x.SESSIONS_BUCKET){let B=await x.SESSIONS_BUCKET.list({prefix:"sessions/",limit:100});for(let A of B.objects){let F=await x.SESSIONS_BUCKET.get(A.key);if(F){let J=await F.json();y.push({sessionId:J.sessionId,username:J.username,loginTime:J.loginTime,expiresAt:J.expiresAt,size:A.size})}}}return new Response(JSON.stringify({sessions:y,count:y.length,timestamp:new Date().toISOString()}),{headers:{...E,"Content-Type":"application/json"}})}catch(y){return new Response(JSON.stringify({error:"Failed to list sessions",message:y?.message||"Unknown error"}),{status:500,headers:{...E,"Content-Type":"application/json"}})}}async function X(G,x,E){try{let y=0,B=0;if(x.SESSIONS_BUCKET){let F=await x.SESSIONS_BUCKET.list({prefix:"sessions/"});y=F.objects.length,B=F.objects.reduce((J,K)=>J+(K.size||0),0)}let A={sessions:{active:y,totalSize:B,averageSize:y>0?Math.round(B/y):0},environment:x.CLOUDFLARE_ENV||"production",version:x.PUBLIC_VERSION||"1.6.0",apiUrl:x.PUBLIC_API_URL,features:{r2_sessions:!!x.SESSIONS_BUCKET,kv_metadata:!!x.SESSION_METADATA,d1_database:!!x.USER_DB,queue_events:!!x.SESSION_EVENTS,analytics:!!x.ANALYTICS},timestamp:new Date().toISOString()};return new Response(JSON.stringify(A),{headers:{...E,"Content-Type":"application/json"}})}catch(y){return new Response(JSON.stringify({error:"Failed to get metrics",message:y?.message||"Unknown error"}),{status:500,headers:{...E,"Content-Type":"application/json"}})}}async function Y(G,x,E){try{if(!x.SESSIONS_BUCKET)return new Response(JSON.stringify({error:"R2 bucket not available",message:"SESSIONS_BUCKET binding not found"}),{status:503,headers:{...E,"Content-Type":"application/json"}});let{objects:y}=await x.SESSIONS_BUCKET.list({prefix:"sessions/"}),B=await Promise.all(y.slice(0,3).map(async(A)=>{let F=await x.SESSIONS_BUCKET.get(A.key);return{key:A.key,size:A.size,etag:A.etag,uploaded:A.uploaded,data:F?await F.text():null}}));return new Response(JSON.stringify({success:!0,bucket:{name:"enterprise-sessions-prod",available:!0},objects:{count:y.length,totalSize:y.reduce((A,F)=>A+(F.size||0),0),prefix:"sessions/"},sample:B,timestamp:new Date().toISOString()}),{headers:{...E,"Content-Type":"application/json"}})}catch(y){return new Response(JSON.stringify({error:"R2 debug failed",message:y?.message||"Unknown error",timestamp:new Date().toISOString()}),{status:500,headers:{...E,"Content-Type":"application/json"}})}}export{Z as default};
