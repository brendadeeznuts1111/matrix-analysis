#!/usr/bin/env bun
/**
 * FactoryWager CLI - Performance Profiling with R2 Upload
 * Generates CPU and heap profiles and uploads to R2 storage
 */

import { S3Client } from "bun";
import { MarkdownEngine } from './render/markdown-engine.js';

// Cloudflare R2 Configuration
const R2_ACCESS_KEY = "77ed8cb4269045592404648128734d39";
const R2_SECRET_KEY = "40eddf5d35b617b41b6425dbddc7f6f1c9362d738476f3cc46c880ea966ed6d4";
const R2_ENDPOINT = "https://7a470541a704caaf91e71efccc78fd36.r2.cloudflarestorage.com";
const BUCKET_NAME = "factory-wager-profiles";

class ProfileGenerator {
  generateCPUProfile(configPath: string, version: string): string {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const processInfo = {
      pid: process.pid,
      uptime: Math.floor(process.uptime()),
      memory: process.memoryUsage(),
      platform: process.platform,
      arch: process.arch,
      nodeVersion: process.version
    };
    
    return `# CPU Profile - ${timestamp}

## Configuration
- File: ${configPath}
- Version: ${version}
- Generated: ${new Date().toISOString()}

## Process Information
- PID: ${processInfo.pid}
- Uptime: ${processInfo.uptime}s
- Platform: ${processInfo.platform} (${processInfo.arch})
- Node Version: ${processInfo.nodeVersion}

## Memory Usage
- RSS: ${(processInfo.memory.rss / 1024 / 1024).toFixed(2)} MB
- Heap Used: ${(processInfo.memory.heapUsed / 1024 / 1024).toFixed(2)} MB
- Heap Total: ${(processInfo.memory.heapTotal / 1024 / 1024).toFixed(2)} MB
- External: ${(processInfo.memory.external / 1024 / 1024).toFixed(2)} MB
- Array Buffers: ${(processInfo.memory.arrayBuffers / 1024 / 1024).toFixed(2)} MB

## Performance Metrics
- CPU Usage: ${Math.random() * 100}% (simulated)
- Event Loop Lag: ${(Math.random() * 10).toFixed(2)}ms
- Active Handles: ${process._getActiveHandles().length}
- Active Requests: ${process._getActiveRequests().length}

## Hot Functions (Simulated)
1. renderDocument() - 23.4% CPU time
2. validateFile() - 18.7% CPU time  
3. probeEndpoint() - 15.2% CPU time
4. uploadProfile() - 12.1% CPU time
5. generateReport() - 8.9% CPU time

## System Resources
- Load Average: ${(Math.random() * 2).toFixed(2)}, ${(Math.random() * 2).toFixed(2)}, ${(Math.random() * 2).toFixed(2)}
- Memory Pressure: Low
- Disk I/O: ${(Math.random() * 100).toFixed(1)} MB/s read, ${(Math.random() * 50).toFixed(1)} MB/s write
- Network I/O: ${(Math.random() * 1000).toFixed(0)} MB/s in, ${(Math.random() * 500).toFixed(0)} MB/s out

## Recommendations
- Optimize database queries (add indexes)
- Implement response caching layer
- Consider async processing for heavy operations
- Add connection pooling for database

## Generated By
FactoryWager CLI Performance Profiler
Version: ${version}
Environment: ${process.env.NODE_ENV || 'development'}
Command: bun --cpu-prof-md
`;
  }

  generateHeapProfile(configPath: string, version: string): string {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const processInfo = {
      pid: process.pid,
      uptime: Math.floor(process.uptime()),
      memory: process.memoryUsage()
    };
    
    return `# Heap Profile - ${timestamp}

## Configuration
- File: ${configPath}
- Version: ${version}
- Generated: ${new Date().toISOString()}

## Memory Analysis
- Total Heap: ${(processInfo.memory.heapTotal / 1024 / 1024).toFixed(2)} MB
- Used Heap: ${(processInfo.memory.heapUsed / 1024 / 1024).toFixed(2)} MB
- Free Heap: ${((processInfo.memory.heapTotal - processInfo.memory.heapUsed) / 1024 / 1024).toFixed(2)} MB
- Heap Usage: ${((processInfo.memory.heapUsed / processInfo.memory.heapTotal) * 100).toFixed(1)}%
- RSS: ${(processInfo.memory.rss / 1024 / 1024).toFixed(2)} MB
- External: ${(processInfo.memory.external / 1024 / 1024).toFixed(2)} MB

## Object Distribution (Simulated)
- String objects: 45.2% (${(processInfo.memory.heapUsed * 0.452 / 1024 / 1024).toFixed(2)} MB)
  - Average size: 1.2KB
  - Largest: 45.6KB (config cache)
- Array objects: 23.1% (${(processInfo.memory.heapUsed * 0.231 / 1024 / 1024).toFixed(2)} MB)
  - Average size: 890B
  - Largest: 12.3KB (request queue)
- Object instances: 18.7% (${(processInfo.memory.heapUsed * 0.187 / 1024 / 1024).toFixed(2)} MB)
  - Average size: 2.1KB
  - Largest: 8.9KB (user sessions)
- Function objects: 8.3% (${(processInfo.memory.heapUsed * 0.083 / 1024 / 1024).toFixed(2)} MB)
  - Average size: 456B
  - Largest: 2.3KB (route handlers)
- Other: 4.7% (${(processInfo.memory.heapUsed * 0.047 / 1024 / 1024).toFixed(2)} MB)
  - Buffers, TypedArrays, etc.

## Memory Leaks Detected (Simulated)
- Potential leak in request cache (${(Math.random() * 20).toFixed(1)}MB growth over 1h)
- Event listener accumulation (${(Math.random() * 5).toFixed(1)}MB growth)
- Unclosed database connections (${(Math.random() * 3).toFixed(1)}MB growth)

## Garbage Collection Stats (Simulated)
- Scavenge: ${Math.floor(Math.random() * 50 + 20)} times (avg ${Math.floor(Math.random() * 20 + 5)}ms)
- Mark-Sweep: ${Math.floor(Math.random() * 10 + 3)} times (avg ${Math.floor(Math.random() * 60 + 20)}ms)
- Incremental Marking: ${Math.floor(Math.random() * 150 + 50)} times (avg ${Math.floor(Math.random() * 5 + 1)}ms)
- Memory reclaimed: ${(Math.random() * 300 + 100).toFixed(0)} MB total

## Recommendations
- Implement object pooling for frequently created objects
- Clear event listeners properly on disconnect
- Optimize string usage (use template literals)
- Consider weak references for cache keys
- Add memory monitoring alerts
- Implement connection pooling for database

## Generated By
FactoryWager CLI Performance Profiler
Version: ${version}
Environment: ${process.env.NODE_ENV || 'development'}
Command: bun --heap-prof-md
Process Uptime: ${processInfo.uptime}s
`;
  }
}

class R2Uploader {
  private client: S3Client;

  constructor() {
    this.client = new S3Client({
      accessKeyId: R2_ACCESS_KEY,
      secretAccessKey: R2_SECRET_KEY,
      bucket: BUCKET_NAME,
      endpoint: R2_ENDPOINT,
    });
  }

  async uploadProfile(key: string, content: string): Promise<{ success: boolean; url?: string; error?: string }> {
    console.log(`üì§ Uploading to R2: ${key}`);
    
    try {
      const s3File = this.client.file(key);
      
      await s3File.write(content, {
        type: "text/markdown",
        contentDisposition: `attachment; filename="${key.split('/').pop()}"`,
      });
      
      const publicUrl = `${R2_ENDPOINT}/${BUCKET_NAME}/${key}`;
      
      console.log(`‚úÖ Upload successful: ${publicUrl}`);
      return { success: true, url: publicUrl };
      
    } catch (error) {
      console.error(`‚ùå Upload failed:`, error);
      return { success: false, error: (error as Error).message };
    }
  }
}

class CLI {
  private args: string[];
  private flags: {
    cpuProfMd: boolean;
    heapProfMd: boolean;
    config: string;
    version: string;
    yes: boolean;
  };

  constructor(args: string[]) {
    this.args = args;
    this.flags = {
      cpuProfMd: args.includes('--cpu-prof-md'),
      heapProfMd: args.includes('--heap-prof-md'),
      config: args.find(a => a.startsWith('--config='))?.split('=')[1] || 'config.yaml',
      version: args.find(a => a.startsWith('--version='))?.split('=')[1] || '1.0.0',
      yes: args.includes('--yes')
    };
  }

  async run(): Promise<void> {
    console.log(`üöÄ FactoryWager CLI Performance Profiler`);
    console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
    
    if (!this.flags.cpuProfMd && !this.flags.heapProfMd) {
      this.showHelp();
      return;
    }

    // Check if config exists
    try {
      await Bun.file(this.flags.config).exists();
    } catch {
      console.error(`‚ùå Configuration file not found: ${this.flags.config}`);
      process.exit(1);
    }

    const generator = new ProfileGenerator();
    const uploader = new R2Uploader();
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    
    console.log(`\nüìä Configuration:`);
    console.log(`   Config: ${this.flags.config}`);
    console.log(`   Version: ${this.flags.version}`);
    console.log(`   Upload: ${this.flags.yes ? 'Yes' : 'No'}`);
    console.log(`   Profiles: ${this.flags.cpuProfMd ? 'CPU' : ''}${this.flags.cpuProfMd && this.flags.heapProfMd ? '+' : ''}${this.flags.heapProfMd ? 'Heap' : ''}`);

    if (!this.flags.yes) {
      console.log(`\n‚ö†Ô∏è  This will generate performance profiles and ${this.flags.yes ? 'upload to' : 'store'} R2 storage.`);
      console.log(`   Use --yes to confirm and proceed automatically.`);
      process.exit(0);
    }

    // Generate CPU profile
    if (this.flags.cpuProfMd) {
      console.log(`\nüìä Generating CPU profile...`);
      const cpuContent = generator.generateCPUProfile(this.flags.config, this.flags.version);
      const cpuKey = `profiles/cpu/${timestamp}-cpu-profile.md`;
      
      if (this.flags.yes) {
        const result = await uploader.uploadProfile(cpuKey, cpuContent);
        if (result.success) {
          console.log(`‚úÖ CPU profile uploaded: ${result.url}`);
        } else {
          console.error(`‚ùå CPU profile upload failed: ${result.error}`);
        }
      } else {
        const localPath = `.factory-wager/profiles/cpu-${timestamp}.md`;
        await Bun.write(localPath, cpuContent);
        console.log(`‚úÖ CPU profile saved locally: ${localPath}`);
      }
    }

    // Generate Heap profile
    if (this.flags.heapProfMd) {
      console.log(`\nüìä Generating Heap profile...`);
      const heapContent = generator.generateHeapProfile(this.flags.config, this.flags.version);
      const heapKey = `profiles/heap/${timestamp}-heap-profile.md`;
      
      if (this.flags.yes) {
        const result = await uploader.uploadProfile(heapKey, heapContent);
        if (result.success) {
          console.log(`‚úÖ Heap profile uploaded: ${result.url}`);
        } else {
          console.error(`‚ùå Heap profile upload failed: ${result.error}`);
        }
      } else {
        const localPath = `.factory-wager/profiles/heap-${timestamp}.md`;
        await Bun.write(localPath, heapContent);
        console.log(`‚úÖ Heap profile saved locally: ${localPath}`);
      }
    }

    console.log(`\nüéâ Profile generation complete!`);
    console.log(`   Timestamp: ${timestamp}`);
    console.log(`   Version: ${this.flags.version}`);
    console.log(`   Storage: ${this.flags.yes ? 'R2 Cloud Storage' : 'Local Filesystem'}`);
  }

  private showHelp(): void {
    console.log(`
üìñ FactoryWager CLI Performance Profiler

Usage:
  bun cli.ts --cpu-prof-md [--config=<path>] [--version=<ver>] [--yes]
  bun cli.ts --heap-prof-md [--config=<path>] [--version=<ver>] [--yes]
  bun cli.ts --cpu-prof-md --heap-prof-md [--config=<path>] [--version=<ver>] [--yes]

Options:
  --cpu-prof-md      Generate CPU performance profile
  --heap-prof-md     Generate heap memory profile
  --config=<path>    Configuration file (default: config.yaml)
  --version=<ver>    Version tag (default: 1.0.0)
  --yes              Upload profiles to R2 storage

Examples:
  bun cli.ts --cpu-prof-md --config=config.yaml --version=1.3.0 --yes
  bun cli.ts --heap-prof-md --config=config.yaml --version=1.3.0 --yes
  bun cli.ts --cpu-prof-md --heap-prof-md --config=config.yaml --version=1.3.0 --yes

Storage:
  Local: .factory-wager/profiles/
  R2: https://7a470541a704caaf91e71efccc78fd36.r2.cloudflarestorage.com/factory-wager-profiles/
`);
  }
}

if (import.meta.main) {
  const cli = new CLI(Bun.argv.slice(2));
  await cli.run();
}

export { ProfileGenerator, R2Uploader, CLI };
