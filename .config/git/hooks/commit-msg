#!/bin/bash
# Factory Wager Enterprise Commit Governance
# Domain: factory-wager.com
# Schema: [DOMAIN][COMPONENT:SCOPE][TIER:N%] Subject
# Backup: commit-msg.backup

set -e

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)

# Skip merge commits and fixups
if echo "$FIRST_LINE" | grep -qE "^(Merge|fixup!|squash!|amend!)"; then
    exit 0
fi

# Skip during rebase
if [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ]; then
    exit 0
fi

echo "ğŸ” Validating commit message format..."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FACTORY WAGER ENTERPRISE GOVERNANCE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Schema: [DOMAIN][COMPONENT:SCOPE][TIER:N%] Subject
#
# DOMAIN: Enterprise area (RUNTIME, SECURITY, PLATFORM, INFRA, etc.)
# COMPONENT: Specific component (JSC, GUARDIAN, FORENSICS, DEPLOY, etc.)
# TIER: Compliance level (500%-1500%)
#
# Examples:
#   [RUNTIME][COMPONENT:JSC][TIER:950] Add deterministic execution
#   [SECURITY][COMPONENT:FORENSICS][TIER:1320] ARM64 verification
#   [PLATFORM][COMPONENT:DEPLOY][TIER:1320] Production hardening
#   [INFRA][COMPONENT:BENCHMARK] Performance regression suite
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Valid Enterprise Domains
VALID_DOMAINS="RUNTIME|SECURITY|PLATFORM|INFRA|BUN|PM|SYSTEM|CLI|SHELL|API|DB|UI|CONFIG|BUILD|TEST|DOCS|CORE|LIB|SCRIPTS|TOOLS|MCP|HOOKS|PKG|POLICY"

# Valid Components
VALID_COMPONENTS="JSC|GUARDIAN|ATTESTATION|FORENSICS|DEPLOY|BENCHMARK|REGISTRY|VERSION|GOVERNANCE|BENCH|AUTH|ROUTER|SQLITE|ZSHRC|MATRIX|CHRONOSTASIS|OMEGA|SECRETS"

# Valid Types (legacy support)
VALID_TYPES="FIX|FEAT|REFACTOR|PERF|CHORE|DOCS|TEST|STYLE|BUILD|CI|REVERT|WIP"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PATTERN MATCHING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Pattern 1: Factory Wager Governance (preferred)
# [DOMAIN][COMPONENT:SCOPE][TIER:N%] Subject
GOVERNANCE_REGEX='^\[[A-Z]+\](\[COMPONENT:[A-Z0-9_-]+\])?(\[TIER:[0-9]+%?\])? .+'

# Pattern 2: Legacy 3-tag format (backwards compatible)
# [DOMAIN][SCOPE][TYPE] Subject
LEGACY_REGEX='^\[[A-Z_-]+\]\[[A-Z0-9_-]+\]\[('${VALID_TYPES}')\]'

# Check for governance pattern first
if echo "$FIRST_LINE" | grep -qE "$GOVERNANCE_REGEX"; then
    # Extract and validate DOMAIN
    DOMAIN=$(echo "$FIRST_LINE" | sed -E 's/^\[([A-Z]+)\].*/\1/')

    if ! echo "$VALID_DOMAINS" | grep -qE "(^|\\|)$DOMAIN(\\||$)"; then
        echo ""
        echo "âŒ Unknown domain: [$DOMAIN]"
        echo "   Valid: $VALID_DOMAINS"
        echo ""
        exit 1
    fi

    # Extract TIER if present (compliance tracking)
    TIER=$(echo "$FIRST_LINE" | grep -oE '\[TIER:[0-9]+' | sed 's/\[TIER://')

    if [ -n "$TIER" ] && [ "$TIER" -lt 500 ]; then
        echo "âš ï¸  WARNING: Tier $TIER% below minimum (500%)"
    fi

    # Extract COMPONENT if present
    COMPONENT=$(echo "$FIRST_LINE" | grep -oE '\[COMPONENT:[A-Z0-9_-]+' | sed 's/\[COMPONENT://')

    if [ -n "$COMPONENT" ] && ! echo "$VALID_COMPONENTS" | grep -qE "(^|\\|)$COMPONENT(\\||$)"; then
        echo "âš ï¸  Unknown component: $COMPONENT (continuing anyway)"
    fi

    # Build success message
    MSG="âœ… Factory Wager Governance: [$DOMAIN]"
    [ -n "$COMPONENT" ] && MSG="$MSG[COMPONENT:$COMPONENT]"
    [ -n "$TIER" ] && MSG="$MSG[TIER:$TIER%]"
    MSG="$MSG verified"
    echo "$MSG"
    exit 0
fi

# Check for legacy pattern
if echo "$FIRST_LINE" | grep -qE "$LEGACY_REGEX"; then
    echo "âœ… Legacy format accepted (consider migrating to [DOMAIN][COMPONENT:X][TIER:N%])"
    exit 0
fi

# Neither pattern matched
echo ""
echo "ğŸš¨ FACTORY WAGER GOVERNANCE VIOLATION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âŒ Invalid commit message format"
echo ""
echo "ğŸ“‹ PREFERRED FORMAT (Factory Wager Governance):"
echo "   [DOMAIN][COMPONENT:SCOPE][TIER:N%] Subject"
echo ""
echo "ğŸ¯ EXAMPLES:"
echo "   [RUNTIME][COMPONENT:JSC][TIER:950] Add deterministic execution"
echo "   [SECURITY][COMPONENT:FORENSICS][TIER:1320] ARM64 verification"
echo "   [PLATFORM][COMPONENT:DEPLOY][TIER:1320] Production hardening"
echo "   [INFRA][COMPONENT:BENCHMARK] Performance regression suite"
echo ""
echo "ğŸ“‹ LEGACY FORMAT (also accepted):"
echo "   [DOMAIN][SCOPE][TYPE] Subject"
echo ""
echo "ğŸ¯ LEGACY EXAMPLES:"
echo "   [CLI][AUTH][FEAT] Add OAuth2 login flow"
echo "   [API][ROUTER][FIX] Handle null response"
echo ""
echo "ğŸ“Š VALID DOMAINS: RUNTIME, SECURITY, PLATFORM, INFRA, BUN, PM, SYSTEM, CLI, API, DB, POLICY, etc."
echo "ğŸ”§ VALID COMPONENTS: JSC, GUARDIAN, FORENSICS, DEPLOY, BENCHMARK, REGISTRY, VERSION, MATRIX, CHRONOSTASIS"
echo "ğŸ† VALID TIERS: 500%-1500%"
echo ""
echo "Your message:"
echo "   $FIRST_LINE"
echo ""
echo "To bypass: git commit --no-verify"
echo ""
exit 1
