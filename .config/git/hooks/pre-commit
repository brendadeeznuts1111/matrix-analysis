#!/usr/bin/env bash
# BUN-PURE PRE-COMMIT HOOK v2.0
# Fast, comprehensive quality checks before every commit

set -e

echo "๐ Bun-Pure pre-commit checks..."

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 0. STAGED FILES DETECTION
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
STAGED_TS=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' || true)
STAGED_ALL=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_ALL" ]; then
  echo "โ No staged files"
  exit 0
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 1. SYNTAX CHECK (Fast - only staged TS files)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if [ -n "$STAGED_TS" ]; then
  echo "๐ Checking TypeScript syntax..."

  for file in $STAGED_TS; do
    if [ -f "$file" ]; then
      # Quick parse check - look for actual syntax errors in build output
      BUILD_OUTPUT=$(bun build --no-bundle "$file" 2>&1)
      if echo "$BUILD_OUTPUT" | grep -qE "^error:|SyntaxError"; then
        echo "โ Syntax error in $file"
        echo "$BUILD_OUTPUT" | grep -E "^error:|SyntaxError" | head -3
        exit 1
      fi
    fi
  done
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 2. BIOME LINT/FORMAT CHECK (staged files only)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if [ -n "$STAGED_TS" ]; then
  # Check if biome is available
  if command -v bunx &> /dev/null; then
    echo "๐งน Running Biome lint/format check..."

    # Run biome check on staged files (lint + format)
    if ! bunx @biomejs/biome check --no-errors-on-unmatched $STAGED_TS 2>/dev/null; then
      echo "โ Biome found issues. Run: bunx @biomejs/biome check --write"
      exit 1
    fi
  fi
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3. BUN-PURE SCAN (Detect anti-patterns)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if [ -n "$STAGED_TS" ] && [ -f ~/.claude/scripts/scan.ts ]; then
  echo "๐ฌ Scanning for anti-patterns..."

  SCAN_FAILED=0
  for file in $STAGED_TS; do
    if [ -f "$file" ]; then
      # Check for common anti-patterns inline (fast)
      # Package anti-patterns
      if grep -qE "from ['\"]express['\"]|from ['\"]axios['\"]|from ['\"]chalk['\"]" "$file" 2>/dev/null; then
        echo "โ๏ธ  Anti-pattern in $file"
        echo "   Use Bun-native APIs: Bun.serve(), fetch(), Bun.color()"
        SCAN_FAILED=1
      fi

      # Node.js API anti-patterns
      if grep -qE "from ['\"]child_process['\"]|require\(['\"]child_process['\"]\)" "$file" 2>/dev/null; then
        echo "โ๏ธ  Node anti-pattern in $file: child_process"
        echo "   Use Bun.spawn() or Bun.\$ instead"
        SCAN_FAILED=1
      fi

      if grep -qE "fs\.(readFile|writeFile|readFileSync|writeFileSync)" "$file" 2>/dev/null; then
        echo "โ๏ธ  Node anti-pattern in $file: fs.read/write"
        echo "   Use Bun.file().text() / Bun.write() instead"
        SCAN_FAILED=1
      fi

      # node:fs imports (mkdirSync, etc)
      if grep -qE "from ['\"]node:fs['\"]" "$file" 2>/dev/null; then
        echo "โ๏ธ  Node anti-pattern in $file: node:fs import"
        echo "   Use Bun.spawn(['mkdir', '-p', dir]) or import from 'bun'"
        SCAN_FAILED=1
      fi

      # Bun 1.3.7+ anti-patterns
      # Manual JSONL parsing (use Bun.JSONL.parse)
      if grep -qE "split\(['\"]\\\\n['\"]\).*map.*JSON\.parse|\.split\(['\"]\\\\n['\"]\)\.filter" "$file" 2>/dev/null; then
        echo "โ๏ธ  Anti-pattern in $file: manual JSONL parsing"
        echo "   Use Bun.JSONL.parse(content) instead (Bun 1.3.7+)"
        SCAN_FAILED=1
      fi

      # wrap-ansi npm package (use Bun.wrapAnsi)
      if grep -qE "from ['\"]wrap-ansi['\"]|require\(['\"]wrap-ansi['\"]\)" "$file" 2>/dev/null; then
        echo "โ๏ธ  Anti-pattern in $file: wrap-ansi package"
        echo "   Use Bun.wrapAnsi(text, columns) instead (Bun 1.3.7+, 33-88x faster)"
        SCAN_FAILED=1
      fi

      # string-width npm package (use Bun.stringWidth)
      if grep -qE "from ['\"]string-width['\"]|require\(['\"]string-width['\"]\)" "$file" 2>/dev/null; then
        echo "โ๏ธ  Anti-pattern in $file: string-width package"
        echo "   Use Bun.stringWidth(text) instead (Bun-native)"
        SCAN_FAILED=1
      fi
    fi
  done

  if [ $SCAN_FAILED -eq 1 ] && [ "${BUN_STRICT:-}" = "1" ]; then
    echo "โ Anti-patterns detected (BUN_STRICT=1)"
    exit 1
  fi
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3b. BUN API SPELLING CHECK
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if [ -n "$STAGED_TS" ] && [ -f ~/.claude/scripts/bun-api-check.ts ]; then
  echo "๐ Checking Bun API spelling..."

  # Run the checker on staged files
  API_CHECK_OUTPUT=$(bun ~/.claude/scripts/bun-api-check.ts --quiet $STAGED_TS 2>&1 || true)

  if [ -n "$API_CHECK_OUTPUT" ]; then
    echo "$API_CHECK_OUTPUT"
    if [ "${BUN_STRICT:-}" = "1" ]; then
      echo "โ Bun API spelling issues detected (BUN_STRICT=1)"
      exit 1
    fi
  fi
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 4. SECURITY CHECKS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ Security scan..."

# Check for hardcoded secrets
SECRET_PATTERNS='(api[_-]?key|secret|password|token|auth)["\s]*[:=]["\s]*["\x27][A-Za-z0-9+/=]{16,}'
for file in $STAGED_ALL; do
  if [ -f "$file" ] && [[ ! "$file" =~ \.example$|\.sample$|\.test\. ]]; then
    if grep -qEi "$SECRET_PATTERNS" "$file" 2>/dev/null; then
      echo "โ๏ธ  Possible secret in $file"
      echo "   Move to .env and use process.env"
    fi
  fi
done

# Check for .env files being committed
if echo "$STAGED_ALL" | grep -qE '^\.env$|^\.env\.local$|^\.env\.production$'; then
  echo "โ BLOCKED: .env file staged for commit"
  echo "   Run: git reset HEAD .env*"
  exit 1
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 5. LARGE FILE CHECK
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
MAX_SIZE=500000  # 500KB
for file in $STAGED_ALL; do
  if [ -f "$file" ]; then
    SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
    if [ "$SIZE" -gt "$MAX_SIZE" ]; then
      echo "โ๏ธ  Large file: $file ($(numfmt --to=iec $SIZE 2>/dev/null || echo "${SIZE}B"))"
      echo "   Consider: .gitignore, Git LFS, or compression"
    fi
  fi
done

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 6. DEBUG/CONSOLE CHECK (opt-in strict mode)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if [ "${BUN_NO_CONSOLE:-}" = "1" ] && [ -n "$STAGED_TS" ]; then
  echo "๐งน Checking for debug statements..."

  for file in $STAGED_TS; do
    if [ -f "$file" ] && [[ ! "$file" =~ \.test\.|\.spec\. ]]; then
      if grep -qE "console\.(log|debug|info)\(" "$file" 2>/dev/null; then
        echo "โ๏ธ  Debug statement in $file"
      fi
    fi
  done
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 7. IMPORT CYCLE CHECK (opt-in, can be slow)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if [ "${BUN_CHECK_CYCLES:-}" = "1" ] && [ -n "$STAGED_TS" ]; then
  echo "๐ Checking import cycles..."
  # Would need madge or custom implementation
  # bun run scripts/check-cycles.ts $STAGED_TS
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 8. SUPPLY CHAIN SECURITY NOTE
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Reminder: Use --minimum-release-age 86400 with bun install for supply chain protection
# This ensures packages are at least 24 hours old before installation
# Example: bun install --minimum-release-age 86400

echo "โ Bun-Pure pre-commit passed!"
